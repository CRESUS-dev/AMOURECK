{% extends 'sidebar.html' %}

{% block main %}
<main>
{% include 'messages.html' %}
                    <div class="container-fluid px-4">

                        <h2 class="mt-4">Situation des envois de colis</h2>

                        <hr>


                    <a href="{% url 'package_add' %}" class="btn btn-sm btn-outline-primary">Ajouter un colis</a>

                        <hr>
                        <div class="row">

                          <!-- Champ de recherche -->
                         <div class="justify-content-center " style="background: #eae8e8; border-radius:10px">
                            <div class="row mb-3 " >
                            <div class="col-md-3">
                                    <label for="startDate" class="form-label">üìÖ Date d√©but</label>
                                    <input type="date" id="startDate" class="form-control">
                            </div>
                            <div class="col-md-3">
                                    <label for="endDate" class="form-label">üìÖ Date fin</label>
                                    <input type="date" id="endDate" class="form-control">
                            </div>
                         </div>

                            <div class="row mb-3">
                            <div class="col-md-3">
                                 <input type="text" id="searchinput" class="form-control mb-3" placeholder="üîç Recherche par Nom, pr√©noms, T√©l">
                            </div>
                            <div class="col-md-3">
                                <select  id="filterAgency" class="form-select ">
                                    <option value="">üè¨Toutes les agences</option>
                                    {% for agency in agencies %}
                                        <option value="{{ agency.name | lower }}">{{ agency.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select  id="statut" class="form-select">
                                    <option value="">Statut</option>
                                    <option value="PAYE">PAYE</option>
                                    <option value="NON_PAYE">NON_PAYE</option>
                                </select>
                            </div>
                        </div>
                        </div>
                        <table class="table table-bordered table-striped">
                          <thead>
                            <tr>

                              <th scope="col" class="d-none d-md-table-cell">Agence </th>
                              <th scope="col" >Code </th>
                              <th scope="col" >Client </th>
                              <th scope="col" >Ville de d√©part </th>
                              <th scope="col" >Ville d'arriv√©e </th>
                              <th scope="col" >Prix </th>
                              <th scope="col" >Description </th>
                              <th scope="col" class="d-none d-md-table-cell">Moyen de paiement </th>
                              <th scope="col" class="d-none d-md-table-cell">N¬∞ Mobile Money </th>

                              <th scope="col" > Date</th>
                                <th scope="col" >Statut</th>
                              <th scope="col" >Actions </th>



                            </tr>
                          </thead>
                          <tbody id="packageTableBody">
                                {% for package in packages %}
                            <tr>

                              <td data-field="agency" class="d-none d-md-table-cell" >{{ package.agency }}</td>
                              <td data-field="package_code" >{{ package.package_code }}</td>
                              <td data-field="customer" >{{ package.customer }}</td>
                              <td data-field="departure_town" >{{ package.departure_town }}</td>
                              <td data-field="arrival_town" >{{ package.arrival_town }}</td>
                              <td data-field="price" >{{ package.price }}</td>
                              <td data-field="description" >{{ package.description }}</td>
                              <td data-field="payment_method" class="d-none d-md-table-cell">{{ package.payment_method |default_if_none:"" }}</td>
                              <td data-field="mobile_money_phone_number" class="d-none d-md-table-cell">{{ package.mobile_money_phone_number |default_if_none:""  }}</td>

                                <td data-field="updated_at"  class="d-none d-md-table-cell">{{ package.updated_at|date:"Y-m-d" }}</td>
                                   <td data-field="status">
                                {% if package.status == "PAYE" %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-circle-check me-1"></i> Pay√©
                                    </span>
                                {% elif package.status == "NON_PAYE" %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-circle-xmark me-1"></i> Non pay√©
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-clock me-1"></i> En attente
                                    </span>
                                {% endif %}
</td>


                            <!-- Boutons CRUD -->
                             <td >
                                <div class="d-flex flex-column flex-sm-row gap-2">
{#                                {% if perms.products.change_product %}#}
                                    <a href="{% url 'package_detail' package.id %}" class="btn btn-sm btn-info">Fiche Colis</a>
                                    <a href="{% url 'package_edit' package.id %}" class="btn btn-sm btn-warning">Modifier</a>
{#                                    <a href="{% url 'package_print' package.id %}?preview=1" target="_blank" class="btn btn-sm btn-info">Aper√ßu</a>#}
{#                                    <a href="{% url 'package_print' package.id %}" class="btn btn-sm btn-primary">Imprimer</a>#}

        {#                                {% endif %}#}

        {#                            {% if perms.products.delete_product %}#}
                                <button
                                   class="btn btn-sm btn-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteModal{{ package.id }}">

                                    Supprimer
                                </button>
{#                            {% endif %}#}
                        </div>
                            </td>
                    </tr>



                                <!-- Modale de confirmation -->
                                    <div class="modal fade" id="deleteModal{{ package.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ package.id }}" aria-hidden="true">
                                      <div class="modal-dialog">
                                        <div class="modal-content">
                                          <div class="modal-header">
                                            <h5 class="modal-title" id="deleteModalLabel{{ package.id }}">Confirmation de suppression</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                                          </div>
                                          <div class="modal-body">
                                            √ätes-vous s√ªr de vouloir supprimer l'agence <strong>{{package.package_code }}</strong> ?
                                          </div>
                                          <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>

                                            <form method="post" action="{% url 'package_delete' package.id %}">
                                              {% csrf_token %}
                                              <button type="submit" class="btn btn-danger">Confirmer</button>
                                            </form>
                                          </div>
                                        </div>
                                      </div>
                                    </div>

                        </td>
                            </tr>

                                {% endfor %}

                          </tbody>
                        </table>
                           {% include 'pagination.html' %}

                        </div>

                    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchinput = document.getElementById('searchinput');
    const filterAgency = document.getElementById('filterAgency');
    const filterStatut = document.getElementById('statut');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const rows = document.querySelectorAll('#packageTableBody tr');

    // üîß Normalisation
    function normalizeText(text) {
        return (text || '')
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .trim();
    }

    // Convertit un texte en token standard (pour statut)
    function toToken(text) {
        return normalizeText(text).replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
    }

    // ‚ú® Surbrillance
    function highlightText(element, query) {
        if (!element) return;
        const raw = element.textContent;
        if (!query) { element.innerHTML = raw; return; }
        const regex = new RegExp(`(${query})`, 'gi');
        element.innerHTML = raw.replace(regex, '<mark>$1</mark>');
    }

    // üßÆ Filtrage principal
    function applyFilters() {
        const q = normalizeText(searchinput.value);
        const selectedAgency = normalizeText(filterAgency.value);
        const selectedStatut = toToken(filterStatut.value);

        // üìÖ Dates
        const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
        const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

        rows.forEach(row => {
            const agency = row.querySelector('[data-field="agency"]');
            const package_code = row.querySelector('[data-field="package_code"]');
            const status = row.querySelector('[data-field="status"]');
            const customer = row.querySelector('[data-field="customer"]');
            const phone = row.querySelector('[data-field="mobile_money_phone_number"]');
            const updated_at = row.querySelector('[data-field="updated_at"]');

            const agencyText = normalizeText(agency?.textContent);
            const statusToken = toToken(status?.textContent);
            const packageCodeText = normalizeText(package_code?.textContent);
            const customerText = normalizeText(customer?.textContent);
            const phoneText = normalizeText(phone?.textContent);
            const updatedDate = updated_at ? new Date(updated_at.textContent.trim()) : null;

            // üîç Recherche texte
            const matchesSearch =
                customerText.includes(q) ||
                packageCodeText.includes(q) ||
                phoneText.includes(q);

            // üè¨ Filtre agence
            let matchesAgency = true;
            if (selectedAgency) {
                matchesAgency = agencyText.includes(selectedAgency);
            }

            // üí∞ Filtre statut
            let matchesStatut = true;
            if (selectedStatut) {
                matchesStatut = (statusToken === selectedStatut);
            }

            // üìÖ Filtre de date
            let matchesDate = true;
            if (startDate && updatedDate && updatedDate < startDate) {
                matchesDate = false;
            }
            if (endDate && updatedDate && updatedDate > endDate) {
                matchesDate = false;
            }

            // ‚úÖ Condition finale
            const match = matchesSearch && matchesAgency && matchesStatut && matchesDate;
            row.style.display = match ? '' : 'none';

            [customer, phone, agency, package_code].forEach(cell => {
                if (cell) highlightText(cell, q);
            });
        });
    }

    // üéØ √âv√©nements
    [searchinput, filterAgency, filterStatut, startDateInput, endDateInput].forEach(el => {
        el.addEventListener('change', applyFilters);
        el.addEventListener('keyup', applyFilters);
    });

    // ‚öôÔ∏è Compatibilit√© Select2
    if (window.jQuery && jQuery.fn && jQuery.fn.select2) {
        jQuery(filterAgency).on('select2:select select2:clear', applyFilters);
        jQuery(filterStatut).on('select2:select select2:clear', applyFilters);
    }

    // Initialisation
    applyFilters();
});
</script>





                </main>

{% endblock main %}






