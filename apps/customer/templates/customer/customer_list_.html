{% extends 'sidebar.html' %}

{% block main %}
<main>
{% include 'messages.html' %}
                    <div class="container-fluid px-4">

                        <h2 class="mt-4">Liste des clients</h2>

                        <hr>


                    <a href="{% url 'customer_add' %}" class="btn btn-sm btn-outline-primary">Ajouter un client</a>

                        <hr>
                        <div class="row">

                          <!-- Champ de recherche -->


                        <div class="row mb-3">
                            <div class="col-md-3">
                                 <input type="text" id="searchinput" class="form-control mb-3" placeholder="üîç Recherche par Nom, pr√©noms, T√©l, Pi√®ce d'identit√©">
                            </div>
                            <div class="col-md-3">
                                <select  id="filterCountry" class="form-select ">
                                    <option value="">üåç Tous les pays</option>
                                    {% for country in countries %}
                                        <option value="{{ country.name | lower }}">{{ country.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                             <div class="col-md-3">
                                <select  id="filterAgency" class="form-select ">
                                    <option value="">üè¨ Toutes les agences</option>
                                    {% for agency in agencies %}
                                        <option value="{{ agency.name | lower }}">{{ agency.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <table class="table table-bordered table-striped">
                          <thead>
                            <tr>
                              <th scope="col"class="d-none d-md-table-cell" >Code</th>
                              <th scope="col" >Nom</th>
                              <th scope="col" >Pr√©noms</th>
                              <th scope="col" class="d-none d-md-table-cell">Sexe</th>
                              <th scope="col" >N¬∞ Tel</th>
                              <th scope="col" class="d-none d-md-table-cell" >Email</th>
                              <th scope="col" class="d-none d-md-table-cell">N¬∞ Piece identit√©</th>
                              <th scope="col" class="d-none d-md-table-cell" >Adresse</th>
                              <th scope="col" >Agence</th>
                              <th scope="col" >Pays</th>
                              <th scope="col">Actions</th>
                            </tr>
                          </thead>
                          <tbody id="customerTableBody">
                                {% for customer in customers %}
                            <tr>
                              <td data-field="code" class="d-none d-md-table-cell">{{ customer.code }}</td>
                              <td data-field="lastName" >{{ customer.lastName }}</td>
                              <td data-field="firstName" >{{ customer.firstName }}</td>
                              <td data-field="sex" class="d-none d-md-table-cell">{{ customer.sex }}</td>
                              <td data-field="phone_number" >{{ customer.phone_number|default_if_none:""  }}</td>
                              <td data-field="email" class="d-none d-md-table-cell">{{ customer.email |default_if_none:""  }}</td>
                              <td data-field="IDCardNumber" class="d-none d-md-table-cell">{{ customer.IDCardNumber|default_if_none:""  }}</td>
                              <td data-field="address" class="d-none d-md-table-cell">{{ customer.address |default_if_none:""  }} </td>
                              <td data-field="agency" >{{ customer.agency }}</td>
                              <td data-field="country" >{{ customer.country.name}}</td>

                            <!-- Boutons CRUD -->
                             <td >
                                <div class="d-flex flex-column flex-sm-row gap-2">
{#                                {% if perms.products.change_product %}#}
                                    <a href="{% url 'customer_edit' customer.id %}" class="btn btn-sm btn-warning">Modifier</a>


        {#                            {% if perms.products.delete_product %}#}
                                <button
                                   class="btn btn-sm btn-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteModal{{ customer.id }}">

                                    Supprimer
                                </button>
{#                            {% endif %}#}
                        </div>
                            </td>
                    </tr>



                                <!-- Modale de confirmation -->
                                    <div  class="modal fade" id="deleteModal{{ customer.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ customer.id }}" aria-hidden="true">
                                      <div class="modal-dialog">
                                        <div class="modal-content">
                                          <div class="modal-header">
                                            <h5 class="modal-title" id="deleteModalLabel{{ customer.id }}">Confirmation de suppression</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                                          </div>
                                          <div class="modal-body">
                                            √ätes-vous s√ªr de vouloir supprimer le client <strong>{{customer.lastName }}</strong> ?
                                          </div>
                                          <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>

                                            <form method="post" action="{% url 'customer_delete' customer.id %}">
                                              {% csrf_token %}
                                              <button type="submit" class="btn btn-danger">Confirmer</button>
                                            </form>
                                          </div>
                                        </div>
                                      </div>
                                    </div>

                        </td>
                            </tr>

                                {% endfor %}

                          </tbody>
                        </table>
                           {% include 'pagination.html' %}

                        </div>

                    </div>



<script>
document.addEventListener('DOMContentLoaded', function () {
  const searchinput = document.getElementById('searchinput');
  const filterCountry = document.getElementById('filterCountry');
  const rows = document.querySelectorAll('#customerTableBody tr');

  function normalizeText(text) {
    return (text || '')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .trim();
  }

  function highlightText(element, query) {
    if (!element) return;
    const raw = element.textContent;
    if (!query) { element.innerHTML = raw; return; }
    const regex = new RegExp(`(${query})`, 'gi');
    element.innerHTML = raw.replace(regex, '<mark>$1</mark>');
  }

  function applyFilters() {
    const filter = normalizeText(searchinput.value);
    const selectedCountryText =
      filterCountry.options[filterCountry.selectedIndex]
        ? filterCountry.options[filterCountry.selectedIndex].text
        : '';
    const selectedCountry = normalizeText(selectedCountryText);

    rows.forEach(row => {
      const code = row.querySelector('[data-field="code"]');
      const lastName = row.querySelector('[data-field="lastName"]');
      const firstName = row.querySelector('[data-field="firstName"]');
      const phone_number = row.querySelector('[data-field="phone_number"]');
      const IDCardNumber = row.querySelector('[data-field="IDCardNumber"]');
      const country = row.querySelector('[data-field="country"]');

      const codeText = normalizeText(code?.textContent);
      const lastNameText = normalizeText(lastName?.textContent);
      const firstNameText = normalizeText(firstName?.textContent);
      const phoneText = normalizeText(phone_number?.textContent);
      const idText = normalizeText(IDCardNumber?.textContent);
      const countryText = normalizeText(country?.textContent);

      const matchesSearch =
        codeText.includes(filter) ||
        lastNameText.includes(filter) ||
        firstNameText.includes(filter) ||
        phoneText.includes(filter) ||
        idText.includes(filter);

      //  si aucun pays n‚Äôest s√©lectionn√©, on ne filtre pas du tout
      let matchesCountry = true;
      if (selectedCountry && selectedCountry !== 'tous les pays' && selectedCountry !== 'üåç tous les pays') {
        matchesCountry = countryText === selectedCountry || countryText.includes(selectedCountry);
      }

      const match = matchesSearch && matchesCountry;
      row.style.display = match ? '' : 'none';

      [code, lastName, firstName, phone_number, IDCardNumber, country].forEach(cell => {
        if (cell) highlightText(cell, filter);
      });
    });
  }

  // üîÅ √âv√©nements
  searchinput.addEventListener('keyup', applyFilters);
  filterCountry.addEventListener('change', applyFilters);

  // pour Select2
  if (window.jQuery && jQuery.fn && jQuery.fn.select2) {
    jQuery(filterCountry).on('select2:select', applyFilters);
    jQuery(filterCountry).on('select2:clear', applyFilters);
  }

  applyFilters();
});
</script>







                </main>

{% endblock main %}






