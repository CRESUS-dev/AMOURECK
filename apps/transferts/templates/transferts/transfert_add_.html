{% extends 'sidebar.html' %}
{% load humanize %}
{% block main %}

    <main>
        <div class="container-fluid px-4">
            <h2 class="mt-4">Ajout d'un transfert</h2>

            <hr>
            <div class="row justify-content-center">
                <div class="col-md-6">


                    <form id="customerForm" method="post" enctype="multipart/form-data"
                          class="shadow p-4 bg-light rounded">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ form.sim_card.label_tag }}
                            {{ form.sim_card }}
                            {% if form.sim_card.errors %}
                                <div class="text-danger">
                                    {{ form.sim_card.errors }}
                                </div>
                            {% endif %}
                            <div id="sim-info-box"
                                 style=" padding:10px; border:2px solid #6c757d; margin-top:10px;">
                                <b>Solde SIM : </b> <span id="sim-balance"></span>
                                <br>
                                <b>Devise : </b> <span id="sim-currency"></span>
                            </div>


                        </div>


                        <div class="mb-3">
                            {{ form.operation_type.label_tag }}
                            {{ form.operation_type }}
                            {% if form.operation_type.errors %}
                                <div class="text-danger">
                                    {{ form.operation_type.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.number.label_tag }}
                            {{ form.number }}
                            {% if form.number.errors %}
                                <div class="text-danger">
                                    {{ form.number.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.amount.label_tag }}
                            {{ form.amount }}
                            {% if form.amount.errors %}
                                <div class="text-danger">
                                    {{ form.amount.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.commission_amount.label_tag }}
                            {{ form.commission_amount }}
                            {% if form.commission_amount.errors %}
                                <div class="text-danger">
                                    {{ form.commission_amount.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.screenshot.label_tag }}
                            {{ form.screenshot }}
                            {% if form.screenshot.errors %}
                                <div class="text-danger">
                                    {{ form.screenshot.errors }}
                                </div>
                            {% endif %}
                        </div>


                        <button type="submit" class="btn  text-light w-100" style="background: #04414d">Enregistrer
                        </button>

                        {% for error in form.non_field_errors %}
                            <div style="color: red;">{{ error }}</div>
                        {% endfor %}
                    </form>


                </div>
            </div>
        </div>


    </main>

{% endblock main %}

{% block extra_js %}

    <script>
        function formatNumber(value) {
            const number = Number(value);
            if (isNaN(number)) return value;

            return new Intl.NumberFormat("fr-FR").format(number);
        }

        document.addEventListener("DOMContentLoaded", function () {

            // Fonction métier centrale
            function handleSimChange(simId) {

                if (!simId) return;

                fetch(`/transfert/ajax/simcard-context/?sim_id=${simId}`)
                    .then(r => r.json())
                    .then(data => {

                        // ---- Devise (formulaire) ----
                        const currencySelect = document.getElementById("id_currency");
                        if (currencySelect && data.currency) {
                            currencySelect.innerHTML = "";
                            const opt = document.createElement("option");
                            opt.value = data.currency;
                            opt.textContent = data.currency;
                            opt.selected = true;
                            currencySelect.appendChild(opt);
                        }

                        // ---- Infos SIM ----
                        const formattedBalance = formatNumber(data.balance);
                        document.getElementById("sim-balance").textContent =
                            `${formattedBalance}`;

                        document.getElementById("sim-currency").textContent =
                            data.currency;

                        document.getElementById("sim-info-box").style.display = "block";
                    })
                    .catch(err => console.error(" Erreur fetch :", err));
            }

            //  EVENT DELEGATION (clé)
            document.addEventListener("change", function (event) {

                const target = event.target;

                // On vérifie que c'est bien le champ SIM
                if (target && target.id === "id_sim_card") {
                    handleSimChange(target.value);
                }
            });
        });
    </script>


{% endblock extra_js %}





